<UserControl xmlns="https://github.com/avaloniaui"
			xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			mc:Ignorable="d" d:DesignWidth="760" d:DesignHeight="640"
			x:Class="ManufactPlanner.Views.OrderDetailsPage"
			x:DataType="vm:OrderDetailsViewModel"
			xmlns:vm="using:ManufactPlanner.ViewModels"
			xmlns:converters="using:ManufactPlanner.Converters">
	<UserControl.Resources>
		<converters:BoolToValueConverter x:Key="BoolToValue"/>
		<converters:IsGreaterThanConverter x:Key="IsGreaterThan"/>
		<converters:StringEqualsValueConverter x:Key="StringEqualsValue"/>
		<converters:MarginConverter x:Key="MarginConverter"/>
	</UserControl.Resources>

	<Grid RowDefinitions="Auto,Auto,*">
		<!-- Навигационная цепочка -->
		<StackPanel Grid.Row="0" Orientation="Horizontal" Margin="20,20,20,0" Spacing="5">
			<Button Content="Заказы" Background="Transparent" BorderThickness="0" Foreground="#666" Command="{Binding NavigateToOrdersCommand}"/>
			<TextBlock Text=">" Foreground="#666" VerticalAlignment="Center"/>
			<TextBlock Text="{Binding OrderNumber}" Foreground="#333" FontWeight="Medium" VerticalAlignment="Center"/>
		</StackPanel>

		<!-- Индикатор загрузки -->
		<ProgressBar Grid.Row="1" IsIndeterminate="True" IsVisible="{Binding IsLoading}"
                    VerticalAlignment="Center" HorizontalAlignment="Center" Margin="0,50,0,0"
                    Width="200" Height="10"/>

		<!-- Информация о заказе -->
		<Border Grid.Row="1" Margin="20,15,20,0" Background="White" CornerRadius="8" BoxShadow="0 2 3 #10000000"
                IsVisible="{Binding !IsLoading}">
			<Grid RowDefinitions="Auto,Auto" Margin="20">
				<Grid Grid.Row="0" ColumnDefinitions="*,Auto">
					<StackPanel>
						<TextBlock Text="{Binding OrderName}" FontSize="20" FontWeight="SemiBold" Foreground="#333"/>
						<TextBlock Text="{Binding OrderNumber}" FontSize="14" Foreground="#666" Margin="0,5,0,0"/>
					</StackPanel>

					<StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10">
						<Button Width="110" Height="36"
					IsVisible="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).IsAdministratorOrManager}"
						 CornerRadius="18" Background="{DynamicResource PrimaryBrush}" Command="{Binding EditOrderCommand}">
							<TextBlock Text="Редактировать" FontSize="12" Foreground="White"/>
							<ToolTip.Tip>
								<TextBlock Text="Редактировать информацию о заказе"/>
							</ToolTip.Tip>
						</Button>
						<Button Width="110" Height="36" 
					IsVisible="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).IsAdministratorOrManager}"
						CornerRadius="18" Background="{DynamicResource ErrorBrush}" Command="{Binding DeleteOrderCommand}">
							<TextBlock Text="Удалить" FontSize="12" Foreground="White"/>
							<ToolTip.Tip>
								<TextBlock Text="Удалить заказ"/>
							</ToolTip.Tip>
						</Button>
					</StackPanel>
				</Grid>

				<!-- Детали заказа -->
				<Grid Grid.Row="1" ColumnDefinitions="1*,1*,1*" RowDefinitions="Auto,Auto" Margin="0,20,0,0">
					<StackPanel Grid.Column="0" Grid.Row="0" Margin="0,0,10,15">
						<TextBlock Text="Заказчик" FontSize="12" Foreground="#9E9E9E"/>
						<TextBlock Text="{Binding Customer}" FontSize="14" Foreground="#333" Margin="0,5,0,0" TextWrapping="Wrap"/>
					</StackPanel>

					<StackPanel Grid.Column="1" Grid.Row="0" Margin="0,0,10,15">
						<TextBlock Text="Срок по договору" FontSize="12" Foreground="#9E9E9E"/>
						<TextBlock Text="{Binding ContractDeadline}" FontSize="14" Foreground="#333" Margin="0,5,0,0"/>
					</StackPanel>

					<StackPanel Grid.Column="2" Grid.Row="0" Margin="0,0,0,15">
						<TextBlock Text="Срок поставки" FontSize="12" Foreground="#9E9E9E"/>
						<TextBlock Text="{Binding DeliveryDeadline}" FontSize="14" Foreground="{Binding IsDeliveryDateCritical, Converter={StaticResource BoolToValue}, ConverterParameter='{DynamicResource ErrorBrush},#333'}" Margin="0,5,0,0"/>
					</StackPanel>

					<StackPanel Grid.Column="0" Grid.Row="1">
						<TextBlock Text="Количество" FontSize="12" Foreground="#9E9E9E"/>
						<TextBlock Text="{Binding ContractQuantity}" FontSize="14" Foreground="#333" Margin="0,5,0,0"/>
					</StackPanel>

					<StackPanel Grid.Column="1" Grid.Row="1">
						<TextBlock Text="Сумма заказа" FontSize="12" Foreground="#9E9E9E"/>
						<TextBlock Text="{Binding TotalPrice}" FontSize="14" Foreground="#333" FontWeight="Medium" Margin="0,5,0,0"/>
					</StackPanel>

					<StackPanel Grid.Column="2" Grid.Row="1">
						<TextBlock Text="Статус" FontSize="12" Foreground="#9E9E9E"/>
						<Border Width="" MinWidth="80" Height="24" CornerRadius="12" Padding="10,0" Background="{DynamicResource SuccessBrush}" Opacity="0.2" HorizontalAlignment="Left" Margin="0,5,0,0">
							<TextBlock Text="{Binding Status}" FontSize="12" Foreground="{DynamicResource SuccessBrush}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
						</Border>
					</StackPanel>
				</Grid>
			</Grid>
		</Border>

		<!-- Вкладки и таблица позиций -->
		<Grid Grid.Row="2" Margin="20,20,20,20" RowDefinitions="Auto,*">
			<!-- Кнопка добавления позиции - сначала вынесем ее наверх -->
			<Button Grid.Row="0" Width="150" Height="36" 
					IsVisible="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).IsAdministratorOrManager}"
						CornerRadius="18" Background="{DynamicResource PrimaryBrush}"
                    HorizontalAlignment="Right" Command="{Binding AddPositionCommand}">
				<TextBlock Text="+ Добавить позицию" FontSize="12" Foreground="White"/>
				<ToolTip.Tip>
					<TextBlock Text="Добавить новую позицию в заказ"/>
				</ToolTip.Tip>
			</Button>

			<!-- TabControl для переключения между вкладками -->
			<TabControl Grid.Row="1" SelectedIndex="{Binding SelectedTabIndex}" Background="White" CornerRadius="8" Margin="0,10,0,0">
				<!-- Вкладка Позиции -->
				<TabItem Header="Позиции">
					<Grid RowDefinitions="Auto,*">
						<!-- Заголовок таблицы -->
						<Grid Grid.Row="0" Background="#F8F9FA" Height="40" ColumnDefinitions="100,250,100,100,100,*,Auto">
							<TextBlock Grid.Column="0" Text="№ позиции" FontSize="12" Foreground="#666" FontWeight="Medium" Margin="20,0,0,0" VerticalAlignment="Center"/>
							<TextBlock Grid.Column="1" Text="Наименование" FontSize="12" Foreground="#666" FontWeight="Medium" VerticalAlignment="Center"/>
							<TextBlock Grid.Column="2" Text="Количество" FontSize="12" Foreground="#666" FontWeight="Medium" VerticalAlignment="Center"/>
							<TextBlock Grid.Column="3" Text="Цена" FontSize="12" Foreground="#666" FontWeight="Medium" VerticalAlignment="Center"/>
							<TextBlock Grid.Column="4" Text="Тип разработки" FontSize="12" Foreground="#666" FontWeight="Medium" VerticalAlignment="Center"/>
							<TextBlock Grid.Column="5" Text="Статус" FontSize="12" Foreground="#666" FontWeight="Medium" Margin="20,0,0,0" VerticalAlignment="Center"/>
							<TextBlock Grid.Column="6" Text="Действия" FontSize="12" Foreground="#666" FontWeight="Medium" Margin="5,0" VerticalAlignment="Center"/>
						</Grid>

						<!-- Линия разделителя -->
						<Rectangle Grid.Row="0" Height="1" Fill="#E0E0E0" VerticalAlignment="Bottom" IsHitTestVisible="False"/>

						<!-- Список позиций -->
						<ScrollViewer Grid.Row="1">
							<ItemsControl ItemsSource="{Binding Positions}">
								<ItemsControl.ItemTemplate>
									<DataTemplate>
										<Grid Height="60" ColumnDefinitions="100,250,100,100,100,*,Auto" Background="{Binding IsAlternate, Converter={StaticResource BoolToValue}, ConverterParameter='White,#F9FAFB'}">
											<TextBlock Grid.Column="0" Text="{Binding PositionNumber}" FontSize="13" Foreground="#333" Margin="20,0,0,0" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="1" Text="{Binding ProductName}" FontSize="13" Foreground="#333" VerticalAlignment="Center" TextWrapping="Wrap"/>
											<TextBlock Grid.Column="2" Text="{Binding Quantity}" FontSize="12" Foreground="#333" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="3" Text="{Binding Price}" FontSize="12" Foreground="#333" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="4" Text="{Binding DevelopmentType}" FontSize="12" Foreground="#333" VerticalAlignment="Center"/>

											<!-- Статус позиции -->
											<Border Grid.Column="5" Height="24" Padding="10,0" CornerRadius="12" Background="{Binding StatusColor}" Opacity="0.2" VerticalAlignment="Center" Margin="20,0,0,0" HorizontalAlignment="Left">
												<TextBlock Text="{Binding Status}" FontSize="12" Foreground="{Binding StatusColor}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
											</Border>

											<!-- Меню действий -->
											<StackPanel Grid.Column="6" Orientation="Horizontal" Spacing="5" Margin="5,0" VerticalAlignment="Center">
												<Button Width="24" Height="24"
					IsVisible="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).IsAdministratorOrManager}"
						 CornerRadius="12" Background="#F1F3F4"
                                                    Command="{Binding $parent[ItemsControl].((vm:OrderDetailsViewModel)DataContext).EditPositionCommand}"
                                                    CommandParameter="{Binding Id}">
													<TextBlock Text="✎" FontSize="12" Foreground="#666" HorizontalAlignment="Center" VerticalAlignment="Center"/>
													<ToolTip.Tip>
														<TextBlock Text="Редактировать позицию"/>
													</ToolTip.Tip>
												</Button>
												<Button Width="24" Height="24"
					IsVisible="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).IsAdministratorOrManager}"
						 CornerRadius="12" Background="#FFEBEE"
                                                    Command="{Binding $parent[ItemsControl].((vm:OrderDetailsViewModel)DataContext).DeletePositionCommand}"
                                                    CommandParameter="{Binding Id}">
													<TextBlock Text="✕" FontSize="12" Foreground="#D32F2F" HorizontalAlignment="Center" VerticalAlignment="Center"/>
													<ToolTip.Tip>
														<TextBlock Text="Удалить позицию"/>
													</ToolTip.Tip>
												</Button>
											</StackPanel>

											<!-- Линия разделителя -->
											<Rectangle Grid.ColumnSpan="7" Height="1" Fill="#E0E0E0" VerticalAlignment="Bottom"/>
										</Grid>
									</DataTemplate>
								</ItemsControl.ItemTemplate>
							</ItemsControl>
						</ScrollViewer>
					</Grid>
				</TabItem>

				<!-- Вкладка Документация -->
				<TabItem Header="Документация">
					<Grid RowDefinitions="Auto,*">
						<!-- Заголовок таблицы -->
						<Grid Grid.Row="0" Background="{DynamicResource BackgroundBrush}" Height="40" ColumnDefinitions="100,100,*,120,100,Auto">
							<TextBlock Grid.Column="0" Text="№ позиции" FontSize="12" Foreground="#666" FontWeight="Medium" Margin="20,0,0,0" VerticalAlignment="Center"/>
							<TextBlock Grid.Column="1" Text="Тип документа" FontSize="12" Foreground="#666" FontWeight="Medium" VerticalAlignment="Center"/>
							<TextBlock Grid.Column="2" Text="Наименование позиции" FontSize="12" Foreground="#666" FontWeight="Medium" VerticalAlignment="Center"/>
							<TextBlock Grid.Column="3" Text="Дата" FontSize="12" Foreground="#666" FontWeight="Medium" VerticalAlignment="Center"/>
							<TextBlock Grid.Column="4" Text="Статус" FontSize="12" Foreground="#666" FontWeight="Medium" VerticalAlignment="Center"/>
							<TextBlock Grid.Column="5" Text="Действия" FontSize="12" Foreground="#666" FontWeight="Medium" Margin="5,0" VerticalAlignment="Center"/>
						</Grid>

						<!-- Линия разделителя -->
						<Rectangle Grid.Row="0" Height="1" Fill="{DynamicResource BorderBrush}" VerticalAlignment="Bottom" IsHitTestVisible="False"/>

						<!-- Список документации -->
						<ScrollViewer Grid.Row="1">
							<Grid>
								<ItemsControl ItemsSource="{Binding Documentations}">
									<ItemsControl.ItemTemplate>
										<DataTemplate>
											<Grid Height="60" ColumnDefinitions="100,100,*,120,100,Auto" Background="{Binding IsAlternate, Converter={StaticResource BoolToValue}, ConverterParameter='White,#F9FAFB'}">
												<TextBlock Grid.Column="0" Text="{Binding PositionNumber}" FontSize="13" Foreground="#333" Margin="20,0,0,0" VerticalAlignment="Center"/>
												<TextBlock Grid.Column="1" Text="{Binding DocumentType}" FontSize="13" Foreground="#333" VerticalAlignment="Center"/>
												<TextBlock Grid.Column="2" Text="{Binding PositionName}" FontSize="13" Foreground="#333" VerticalAlignment="Center" TextWrapping="Wrap"/>
												<TextBlock Grid.Column="3" Text="{Binding Date}" FontSize="12" Foreground="#333" VerticalAlignment="Center"/>

												<!-- Статус документа -->
												<Border Grid.Column="4" Height="24" Padding="10,0" CornerRadius="12" Background="{Binding StatusColor}" Opacity="0.2" VerticalAlignment="Center" Margin="0,0,0,0" HorizontalAlignment="Left">
													<TextBlock Text="{Binding Status}" FontSize="12" Foreground="{Binding StatusColor}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
												</Border>

												<!-- Кнопки действий -->
												<StackPanel Grid.Column="5" Orientation="Horizontal" Spacing="5" Margin="5,0" VerticalAlignment="Center">
													<!--<Button Width="24" Height="24" CornerRadius="12" Background="#F1F3F4"
                                                        Command="{Binding $parent[ItemsControl].((vm:OrderDetailsViewModel)DataContext).DownloadDocumentCommand}"
                                                        CommandParameter="{Binding Id}">
                                                        <TextBlock Text="↓" FontSize="12" Foreground="#666" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                        <ToolTip.Tip>
                                                            <TextBlock Text="Скачать документ"/>
                                                        </ToolTip.Tip>
                                                    </Button>
                                                    <Button Width="24" Height="24" CornerRadius="12" Background="#E3F2FD"
                                                        Command="{Binding $parent[ItemsControl].((vm:OrderDetailsViewModel)DataContext).ViewDocumentCommand}"
                                                        CommandParameter="{Binding Id}">
                                                        <TextBlock Text="👁" FontSize="12" Foreground="#2196F3" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                        <ToolTip.Tip>
                                                            <TextBlock Text="Просмотреть документ"/>
                                                        </ToolTip.Tip>
                                                    </Button>-->
												</StackPanel>

												<!-- Линия разделителя -->
												<Rectangle Grid.ColumnSpan="6" Height="1" Fill="{DynamicResource BorderBrush}" VerticalAlignment="Bottom"/>
											</Grid>
										</DataTemplate>
									</ItemsControl.ItemTemplate>
								</ItemsControl>

								<!-- Сообщение, если нет данных -->
								<TextBlock Text="Нет данных о документации"
                                        IsVisible="{Binding Documentations.Count, Converter={StaticResource IsGreaterThan}, ConverterParameter='0 Invert=true'}"
                                        FontSize="16" Foreground="#666" FontWeight="Medium"
                                        HorizontalAlignment="Center" VerticalAlignment="Center"/>
							</Grid>
						</ScrollViewer>
					</Grid>
				</TabItem>

				<!-- Вкладка Сроки -->
				<TabItem Header="Сроки">
					<Grid RowDefinitions="Auto,*">
						<!-- Заголовок таблицы -->
						<Grid Grid.Row="0" Background="{DynamicResource BackgroundBrush}" Height="40" ColumnDefinitions="100,*,150,120">
							<TextBlock Grid.Column="0" Text="№ позиции" FontSize="12" Foreground="#666" FontWeight="Medium" Margin="20,0,0,0" VerticalAlignment="Center"/>
							<TextBlock Grid.Column="1" Text="Наименование" FontSize="12" Foreground="#666" FontWeight="Medium" VerticalAlignment="Center"/>
							<TextBlock Grid.Column="2" Text="Тип срока" FontSize="12" Foreground="#666" FontWeight="Medium" VerticalAlignment="Center"/>
							<TextBlock Grid.Column="3" Text="Плановая дата" FontSize="12" Foreground="#666" FontWeight="Medium" VerticalAlignment="Center"/>
						</Grid>

						<!-- Линия разделителя -->
						<Rectangle Grid.Row="0" Height="1" Fill="{DynamicResource BorderBrush}" VerticalAlignment="Bottom" IsHitTestVisible="False"/>

						<!-- Список сроков -->
						<ScrollViewer Grid.Row="1">
							<Grid>
								<ItemsControl ItemsSource="{Binding Deadlines}">
									<ItemsControl.ItemTemplate>
										<DataTemplate>
											<Grid Height="60" ColumnDefinitions="100,*,150,120" Background="{Binding IsAlternate, Converter={StaticResource BoolToValue}, ConverterParameter='White,#F9FAFB'}">
												<TextBlock Grid.Column="0" Text="{Binding PositionNumber}" FontSize="13" Foreground="#333" Margin="20,0,0,0" VerticalAlignment="Center"/>
												<TextBlock Grid.Column="1" Text="{Binding PositionName}" FontSize="13" Foreground="#333" VerticalAlignment="Center" TextWrapping="Wrap"/>
												<TextBlock Grid.Column="2" Text="{Binding DeadlineType}" FontSize="13" Foreground="#333" VerticalAlignment="Center"/>

												<!-- Плановая дата со статусом (цветом) -->
												<TextBlock Grid.Column="3" Text="{Binding PlannedDate}" FontSize="13" Foreground="{Binding StatusColor}" FontWeight="Medium" VerticalAlignment="Center"/>

												<!-- Линия разделителя -->
												<Rectangle Grid.ColumnSpan="4" Height="1" Fill="{DynamicResource BorderBrush}" VerticalAlignment="Bottom"/>
											</Grid>
										</DataTemplate>
									</ItemsControl.ItemTemplate>
								</ItemsControl>

								<!-- Сообщение, если нет данных -->
								<TextBlock Text="Нет данных о сроках"
                                        IsVisible="{Binding Deadlines.Count, Converter={StaticResource IsGreaterThan}, ConverterParameter='0 Invert=true'}"
                                        FontSize="16" Foreground="#666" FontWeight="Medium"
                                        HorizontalAlignment="Center" VerticalAlignment="Center"/>
							</Grid>
						</ScrollViewer>
					</Grid>
				</TabItem>
			</TabControl>
		</Grid>
	</Grid>
</UserControl>